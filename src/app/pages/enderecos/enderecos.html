<div class="enderecos-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">Endereços</h1>
        <p class="page-subtitle">Gerencie os endereços de entrega</p>
      </div>
      
      <div class="header-actions">
        <button class="btn-primary" (click)="openCreateModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Novo Endereço
        </button>
      </div>
    </div>

    <!-- Cards de Estatísticas -->
    <div class="stats-row">
      <div class="stats-card">
        <div class="stat-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-value">{{ totalEnderecos() }}</span>
          <span class="stat-label">Endereços Cadastrados</span>
        </div>
      </div>

      <div class="stats-card">
        <div class="stat-icon secondary">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <line x1="3" y1="9" x2="21" y2="9"/>
            <line x1="9" y1="21" x2="9" y2="9"/>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-value">{{ quadrasResumo().length }}</span>
          <span class="stat-label">Quadras Atendidas</span>
        </div>
      </div>
    </div>

    <!-- Top Quadras -->
    <div class="quadras-section">
      <div class="quadras-header">
        <h3 class="quadras-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"/>
            <line x1="12" y1="20" x2="12" y2="4"/>
            <line x1="6" y1="20" x2="6" y2="14"/>
          </svg>
          Endereços por Quadra
        </h3>
      </div>
      
      <div class="quadras-grid">
        @for (quadra of paginatedQuadras(); track quadra.quadra; let i = $index) {
          <div class="quadra-card" (click)="filterByQuadra(quadra.quadra)">
            <div class="quadra-rank">{{ (quadrasPage() - 1) * quadrasPerPage() + i + 1 }}º</div>
            <div class="quadra-info">
              <span class="quadra-nome">{{ quadra.quadra }}</span>
              <span class="quadra-count">{{ quadra.totalEnderecos }} endereço(s)</span>
            </div>
            <div class="quadra-bar">
              <div class="quadra-bar-fill" [style.width.%]="(quadra.totalEnderecos / (quadrasResumo()[0]?.totalEnderecos || 1)) * 100"></div>
            </div>
          </div>
        } @empty {
          <p class="no-quadras">Nenhuma quadra cadastrada</p>
        }
      </div>

      <!-- Paginação Quadras -->
      @if (totalQuadrasPages() > 1) {
        <div class="pagination-mini">
          <button class="pagination-btn-mini" (click)="previousQuadrasPage()" [disabled]="quadrasPage() === 1">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <span class="pagination-info">{{ quadrasPage() }} / {{ totalQuadrasPages() }}</span>
          <button class="pagination-btn-mini" (click)="nextQuadrasPage()" [disabled]="quadrasPage() === totalQuadrasPages()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
        </div>
      }
    </div>

    <!-- Barra de Busca e Filtros -->
    <div class="filters-bar">
      <div class="search-box">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Buscar por quadra, alameda, lote..."
          [value]="searchTerm()"
          (input)="updateSearch($event)"
        >
        @if (searchTerm()) {
          <button class="clear-search" (click)="clearSearch()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        }
      </div>

      <div class="filter-buttons">
        <div class="sort-dropdown">
          <button class="btn-filter">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m3 16 4 4 4-4"/>
              <path d="M7 20V4"/>
              <path d="m21 8-4-4-4 4"/>
              <path d="M17 4v16"/>
            </svg>
            Ordenar
          </button>
          <div class="sort-options">
            <button (click)="changeSortOrder('nenhum')" [class.active]="sortOrder() === 'nenhum'">
              Sem ordenação
            </button>
            <button (click)="changeSortOrder('quadra-asc')" [class.active]="sortOrder() === 'quadra-asc'">
              Quadra (A-Z)
            </button>
            <button (click)="changeSortOrder('quadra-desc')" [class.active]="sortOrder() === 'quadra-desc'">
              Quadra (Z-A)
            </button>
            <button (click)="changeSortOrder('mais-clientes')" [class.active]="sortOrder() === 'mais-clientes'">
              Mais clientes
            </button>
            <button (click)="changeSortOrder('menos-clientes')" [class.active]="sortOrder() === 'menos-clientes'">
              Menos clientes
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de Endereços -->
  <div class="enderecos-grid">
    @for (endereco of paginatedEnderecos(); track endereco.id) {
      <div class="endereco-card">
        <div class="card-header">
          <div class="endereco-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
          </div>
          <div class="card-actions-mini">
            <button class="btn-action-mini btn-edit" (click)="openEditModal(endereco, $event)" title="Editar">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </button>
            <button class="btn-action-mini btn-delete" (click)="openDeleteModal(endereco, $event)" title="Excluir">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            </button>
          </div>
        </div>
        
        <div class="card-body">
          <div class="endereco-completo">{{ getEnderecoFormatado(endereco) }}</div>
          
          <div class="endereco-detalhes">
            @if (endereco.quadra) {
              <span class="detalhe-tag quadra">{{ endereco.quadra }}</span>
            }
            @if (endereco.alameda) {
              <span class="detalhe-tag">Al. {{ endereco.alameda }}</span>
            }
            @if (endereco.qi) {
              <span class="detalhe-tag">{{ endereco.qi }}</span>
            }
          </div>

          <div class="endereco-clientes">
            <div class="clientes-header">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
              </svg>
              <span>{{ endereco.clientesIds.length }} cliente(s)</span>
            </div>
            @if (endereco.clientesIds.length > 0) {
              <div class="clientes-list-mini">
                @for (cliente of getClientesDoEndereco(endereco.clientesIds).slice(0, 3); track cliente.id) {
                  <span class="cliente-tag">{{ cliente.nome || 'Sem nome' }}</span>
                }
                @if (endereco.clientesIds.length > 3) {
                  <span class="cliente-tag mais">+{{ endereco.clientesIds.length - 3 }}</span>
                }
              </div>
            }
          </div>
        </div>
      </div>
    } @empty {
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
          <circle cx="12" cy="10" r="3"/>
        </svg>
        <h3>Nenhum endereço encontrado</h3>
        <p>Cadastre seu primeiro endereço</p>
      </div>
    }
  </div>

  <!-- Paginação -->
  @if (totalPages() > 1) {
    <div class="pagination">
      <button class="pagination-btn" (click)="previousPage()" [disabled]="currentPage() === 1">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
      </button>
      
      @for (page of pages(); track page) {
        <button class="pagination-btn" [class.active]="currentPage() === page" (click)="goToPage(page)">
          {{ page }}
        </button>
      }
      
      <button class="pagination-btn" (click)="nextPage()" [disabled]="currentPage() === totalPages()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"/>
        </svg>
      </button>
    </div>
  }

  <!-- Modal Backdrop -->
  @if (modalType()) {
    <div class="modal-backdrop" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        
        <!-- Modal de Criação/Edição -->
        @if (modalType() === 'create' || modalType() === 'edit') {
          <div class="modal-header">
            <h2 class="modal-title">
              {{ modalType() === 'create' ? 'Novo Endereço' : 'Editar Endereço' }}
            </h2>
            <button class="btn-close" (click)="closeModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>

          <form class="modal-form" (ngSubmit)="handleSubmit()">
            <div class="form-row">
              <div class="form-group">
                <label for="quadra">Quadra</label>
                <input 
                  type="text" 
                  id="quadra" 
                  class="form-input"
                  [value]="formData().quadra"
                  (input)="updateQuadra($event)"
                  placeholder="Ex: 104 Norte"
                >
              </div>

              <div class="form-group">
                <label for="alameda">Alameda</label>
                <input 
                  type="text" 
                  id="alameda" 
                  class="form-input"
                  [value]="formData().alameda"
                  (input)="updateAlameda($event)"
                  placeholder="Ex: 01"
                >
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="qi">QI (Quadra Interna)</label>
                <input 
                  type="text" 
                  id="qi" 
                  class="form-input"
                  [value]="formData().qi"
                  (input)="updateQi($event)"
                  placeholder="Ex: QI-05"
                >
              </div>

              <div class="form-group">
                <label for="lote">Lote</label>
                <input 
                  type="text" 
                  id="lote" 
                  class="form-input"
                  [value]="formData().lote"
                  (input)="updateLote($event)"
                  placeholder="Ex: 15"
                >
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="casa">Casa</label>
                <input 
                  type="text" 
                  id="casa" 
                  class="form-input"
                  [value]="formData().casa"
                  (input)="updateCasa($event)"
                  placeholder="Ex: A, B, C"
                >
              </div>

              <div class="form-group">
                <label for="complemento">Complemento</label>
                <input 
                  type="text" 
                  id="complemento" 
                  class="form-input"
                  [value]="formData().complemento"
                  (input)="updateComplemento($event)"
                  placeholder="Ex: Próximo ao mercado"
                >
              </div>
            </div>

            <div class="form-group">
              <label>Clientes</label>
              <div class="clientes-list">
                @for (cliente of clientes(); track cliente.id) {
                  <label class="cliente-checkbox">
                    <input 
                      type="checkbox" 
                      [checked]="formData().clientesIds.includes(cliente.id)"
                      (change)="toggleCliente(cliente.id)"
                    >
                    <span class="checkmark"></span>
                    <span class="cliente-text">
                      <span class="cliente-nome-check">{{ cliente.nome || 'Sem nome' }}</span>
                      @if (cliente.telefone) {
                        <span class="cliente-tel-check">{{ cliente.telefone }}</span>
                      }
                    </span>
                  </label>
                } @empty {
                  <p class="no-clientes">Nenhum cliente cadastrado</p>
                }
              </div>
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-secondary" (click)="closeModal()">
                Cancelar
              </button>
              <button type="submit" class="btn-primary">
                {{ modalType() === 'create' ? 'Cadastrar' : 'Salvar' }}
              </button>
            </div>
          </form>
        }

        <!-- Modal de Exclusão -->
        @if (modalType() === 'delete' && selectedEndereco()) {
          <div class="modal-header">
            <h2 class="modal-title">Excluir Endereço</h2>
            <button class="btn-close" (click)="closeModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>

          <div class="modal-body">
            <div class="confirmation-icon delete">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            </div>
            
            <p class="confirmation-text">
              Tem certeza que deseja excluir o endereço?
            </p>
            
            <div class="endereco-preview">
              {{ getEnderecoFormatado(selectedEndereco()!) }}
            </div>
            
            @if (selectedEndereco()!.clientesIds.length > 0) {
              <div class="confirmation-warning">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="8" x2="12" y2="12"/>
                  <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <div class="warning-content">
                  <strong>Atenção!</strong> Este endereço será desvinculado de {{ selectedEndereco()!.clientesIds.length }} cliente(s):
                  <div class="clientes-afetados">
                    @for (cliente of getClientesDoEndereco(selectedEndereco()!.clientesIds); track cliente.id) {
                      <span class="cliente-afetado">{{ cliente.nome || 'Sem nome' }}</span>
                    }
                  </div>
                </div>
              </div>
            }
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-secondary" (click)="closeModal()">
              Cancelar
            </button>
            <button type="button" class="btn-danger" (click)="confirmDelete()">
              Excluir Endereço
            </button>
          </div>
        }
      </div>
    </div>
  }
</div>